<!doctype html> 

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Labyrinthe</title>
    <style>
        body{
            display: grid;
            justify-content: center;
            grid-template:  "a b" 50%
                            "a c" 50%
        }

        #laby{
            grid-area: a;
        }

        tr{
            border: red solid;
        }

        .boutons.deplacement {
            min-width: 250px;
            height: 200px;
            grid-area: c;
            display: grid;
            grid-template:  "a a a a" 65px
                            "b b c c" 65px
                            "d d d d" 65px;
        }

        .haut{grid-area: a;}
        
        .bas{grid-area: d;}
        
        .gauche{grid-area: b;}
        
        .droite{grid-area: c;}

        .boutons.mode {
            grid-area: b;
            display: grid;
            grid-template:  "a a b b" 40px
                            "c c c c" 40px;
        }
        
        .newGame{grid-area: a;}

        .automatique{grid-area: b;}

        #timer{
            grid-area: c;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #aaa;
            background-color: #ddd;
            height: 30px;
        }

        button {
            display: flex;
            justify-content: center;
            align-items: center;
        }

    </style>
    <script language="JavaScript">
        m='m'; //représente un mur
        p='p'; //représente le personnage
        b='b'; //représente le chemin
        f="f"; //représente le trophée 

        xperso=1; //position initial du personnage sur l'axe X
        yperso=1; //postition initial du personnage sur l'axe Y
        //tableau à double entrée représentant votre labyrinthe, vous pouvez le modifier pour comprendre le fonctionnement
        var game = true
        var startlaby = [[m,m,m,m,m,m,m,m,m,m],
                        [m,p,m,b,b,b,b,b,b,m],
                        [m,b,m,b,m,m,m,b,m,m],
                        [m,b,m,b,m,b,m,b,b,m],
                        [m,b,b,b,m,b,m,m,b,m],
                        [m,b,m,b,m,b,b,b,b,f],
                        [m,m,m,m,m,m,m,m,m,m]];
        
 
        function deepCopy(obj) {
            if (Object.prototype.toString.call(obj) === '[object Array]') {
                var len = obj.length, out = new Array(len), i = 0;
                for ( ; i < len; i++ ) {
                out[i] = arguments.callee(obj[i]);
                }
                return out;
            }
            return obj;
        }

        var laby = deepCopy(startlaby);

        function newGame(){
            timer = setInterval(myTimer, 10);
            time = 0
            timer_active = false;
            laby = deepCopy(startlaby);
            game = true;
            document.querySelector(".haut").removeAttribute("disabled")
            document.querySelector(".bas").removeAttribute("disabled")
            document.querySelector(".gauche").removeAttribute("disabled")
            document.querySelector(".droite").removeAttribute("disabled")
            afficheLaby()
            setclick()
        }

        function findP(){
            for (let i=0; i<laby.length; i++) {
                if (laby[i].includes(p)) {
                    return [i, laby[i].indexOf(p)]
                }
            }
        }

        function setdisabled(){
            clearInterval(timer)
            game = false;
            timer_active = false;
            document.getElementById("laby").innerHTML += `<h1>Tu as gagné en ${Math.floor(time/100)}'${(time%100 < 10)? '0'+time%100: time%100}</h1>`
            document.querySelector(".haut").setAttribute("disabled", "")
            document.querySelector(".bas").setAttribute("disabled", "")
            document.querySelector(".gauche").setAttribute("disabled", "")
            document.querySelector(".droite").setAttribute("disabled", "")
        }

        function haut(){
            [i, j] = findP()
            if (laby[i-1][j]==f){
                [laby[i-1][j], laby[i][j]] = [laby[i][j], b]
                afficheLaby()
                setdisabled()
                return
            }else{
                if (laby[i-1][j]==b){
                [laby[i-1][j], laby[i][j]] = [laby[i][j], laby[i-1][j]]
                }
            }
            afficheLaby()
            setclick()
        }

        function bas(){
            [i, j] = findP()
            if (laby[i+1][j]==f){
                [laby[i+1][j], laby[i][j]] = [laby[i][j], b]
                afficheLaby()
                setdisabled()
                return
            }else{
                if (laby[i+1][j]==b){
                [laby[i+1][j], laby[i][j]] = [laby[i][j], laby[i+1][j]]
                }
            }
            afficheLaby()
            setclick()
        }

        function gauche(){
            [i, j] = findP()
            if (laby[i][j-1]==f){
                [laby[i][j-1], laby[i][j]] = [laby[i][j], b]
                afficheLaby()
                setdisabled()
                return
            }else{
                if (laby[i][j-1]==b){
                [laby[i][j-1], laby[i][j]] = [laby[i][j], laby[i][j-1]]
                }
            }
            afficheLaby()
            setclick()
        }

        function droite(){
            [i, j] = findP()
            if (laby[i][j+1]==f){
                [laby[i][j+1], laby[i][j]] = [laby[i][j], b]
                afficheLaby()
                setdisabled()
                return
            }else{
                if (laby[i][j+1]==b){
                [laby[i][j+1], laby[i][j]] = [laby[i][j], laby[i][j+1]]
                }
            }
            afficheLaby()
            setclick()
        }     
         
        function afficheLaby(){
            var leLaby=document.getElementById("laby");
            insertion="<table border=0 cellspacing=0 cellpadding=0>";
         
            for(i=0;i<7;i++){
            insertion+="<tr>";
                let dico
                for(j=0;j<10;j++){
                    dico = {
                    m : `<img class='${i}${j}' width='52'height='52' src='Assets/stonewall.png'>`,
                    p : `<img class='${i}${j}' width='52' height='52' style='background-image:Assets/Ground.png' src='Assets/Heros.png'>`,
                    b : `<img class='${i}${j}' width='52' height='52' src='Assets/Ground.png'>`,
                    f : `<img class='${i}${j}' width='52' height='52'src='Assets/Trophy.png'>`}
                    insertion+="<td>";
                    insertion+=dico[laby[i][j]];
                    insertion+="</td>";
                    }
                insertion+="</tr>";
            }  
             
            insertion+="</table>";
            leLaby.innerHTML=insertion;
        }

        document.addEventListener('keydown', (e) => {
            if (game){
                timer_active=true;
                if (e.key=='ArrowUp'){haut()}
                if (e.key=='ArrowDown'){bas()}
                if (e.key=='ArrowLeft'){gauche()}
                if (e.key=='ArrowRight'){droite()}
            }
        })


        var timer_active=false;
        var timer = setInterval(myTimer, 10)
        let time = 0
        function myTimer() {
            if (timer_active){time++}
            if (time%100 < 10){time = `0${time}` }
            document.getElementById("timer").innerHTML = `${Math.floor(time/100)}:${(time%100 < 10)? '0'+time%100: time%100}`
        }
        function setclick(){
            for (img of document.querySelectorAll('img')){
                img.addEventListener('click', function(){
                    [i, j] = [Number(this.className[0]), Number(this.className[1])];
                    console.log([i, j]);
                    if (laby[i][j]==b || laby[i][j]== f){
                        console.log(findP());
                        [x, y] = findP()
                        if (x == i-1 && y == j){
                            bas()
                        }else if(x == i+1 && y == j){
                            haut()
                        }else if(x == i && y == j-1){
                            droite()
                        }else if(x == i && y == j+1){
                            gauche()
                        }
                        
                    }
                })
            }
        }

        function automatique(){
            timer_active=true;
            [i, j] = findP();
            auto_laby = deepCopy(startlaby)
            auto = setInterval(function(){
                if (game){
                    console.log(nb_sortie())
                    f_coter()
                    if (nb_sortie()==1){
                        if (laby[i][j-1]== m && laby[i][j+1]== m && laby[i-1][j]== m){
                            [laby[i+1][j], laby[i][j]] = [laby[i][j], m]
                            afficheLaby()
                        }else if (laby[i][j-1]== m && laby[i][ j+1]== m && laby[i+1][j]== m){
                            [laby[i-1][j], laby[i][j]] = [laby[i][j], m]
                            afficheLaby()
                        }else if (laby[i][j-1]== m && laby[i+1][j]== m && laby[i-1][j]== m){
                            [laby[i][j+1], laby[i][j]] = [laby[i][j], m]
                            afficheLaby()
                        }else if (laby[i][j+1]== m && laby[i+1][j]== m && laby[i-1][j]== m){
                            [laby[i][j-1], laby[i][j]] = [laby[i][j], m]
                            afficheLaby()
                        }
                    }else {
                        let nb = Math.floor(Math.random() * nb_sortie())
                        sortie_dispo()[nb]();
                    }
                }else{
                    clearInterval(auto)
                }
            }, 0)
        }

        function sortie_dispo(){
            [i, j] = findP();
            liste = [];
            if (laby[i][j+1]==b){
                liste.push(droite)
            }
            if (laby[i][j-1]==b){
                liste.push(gauche)
            }
            if (laby[i-1][j]==b){
                liste.push(haut)
            }
            if (laby[i+1][j]==b){
                liste.push(bas)
            }return liste
        }

        function f_coter(){
            [i, j] = findP();
            if (laby[i][j-1]==f){
                gauche()
            }else if (laby[i][j+1]==f){
                droite()
            }else if (laby[i-1][j]==f){
                haut()
            }else if (laby[i+1][j]==f){
                bas()
            }
        }

        function nb_sortie(){
            [i, j] = findP();
            let t = 0;
            if (laby[i][j+1]==b){
                t++
            }
            if (laby[i][j-1]==b){
                t++
            }
            if (laby[i-1][j]==b){
                t++
            }
            if (laby[i+1][j]==b){
                t++
            }return t
        }

    </script>
</head>
    <body>
        <div id="laby">
 
        </div>

        <!-- ajouter vos boutons de déplacement ici -->
        <div class="boutons deplacement">
            <button class="haut" onclick="haut()">haut</button>
            <button class="bas" onclick="bas()">bas</button>
            <button class="gauche" onclick="gauche()">gauche</button>
            <button class="droite" onclick="droite()">droite</button>
        </div>
        <div class="boutons mode">
            <button class="newGame" onclick="newGame()">newGame</button>
            <button class="automatique" onclick="automatique()">automatique</button>
            <p id="timer">0:00</p>
        </div>
    </body>
    <script>
        afficheLaby()
        setclick()
        document.querySelector("#laby").addEventListener('click', function(){if (game){timer_active=true;}})
    </script>
</html>